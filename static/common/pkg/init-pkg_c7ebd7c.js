window.requestAnimationFrame||(window.requestAnimationFrame=function(){return window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(n){window.setTimeout(n,1e3/60)}}());
;function Indicator(a,i){this.current=0;var t=$('<div id="indicator"></div>').appendTo($("body"));$.each(a,function(a,i){var e=$('<ul class="indicator-group"></ul>').appendTo(t);if(1==i.frames.length){var n=$('<li class="frameIndicator" si="'+a+'" data-title="'+i.frames[0].name+'"></li>').appendTo(e);0==a&&n.addClass("on")}else $('<li class="frameIndicator" si="'+a+'" data-title="'+i.frames[0].name+'"></li>').appendTo(e),$.each(i.frames,function(i,t){if(i>0){var n=$('<li class="segmentIndicator" si="'+a+'" fi="'+(i-1)+'" data-title="'+t.name+'"></li>').appendTo(e);0==i&&n.addClass("on")}})}),t.css("top",($(window).height()-t.height())/2),t.delegate("li","click",function(){var a=$(this),t=a.attr("si")||0,e=a.attr("fi")||0;i(t,e),CodeStat.addStat({item:"panohome_dot_click"})}),t.delegate("li","mouseover",function(){var a=$(this),i=(a.offset(),$('<div class="indicator-title"></div>').appendTo(a));i.text(a.attr("data-title"))}),t.delegate("li","mouseout",function(){var a=$(this);a.find(".indicator-title").remove()})}Indicator.prototype.update=function(a,i,t,e){function n(a,i){setTimeout(function(){if(0!=a.length){var t=a.pop();i&&"list-item"==t.css("display")||(i?t.show():t.hide(),o.css("top",(s-o.height())/2),n(a,i))}},100)}if("iframe"!=e||this.current==i){var o=$("#indicator"),s=$(window).height(),d=o.find(".indicator-group");if(a!=i){var r=$(d[a]),c=$(d[i]);r.find(".frameIndicator").removeClass("on");var l=r.find(".segmentIndicator"),f=[],h=[];l.length>0&&l.each(function(a,i){var t=$(i).removeClass("on");f.push(t)});var m=c.find(".segmentIndicator");m.length>0?m.each(function(a,i){var e=$(i).removeClass("on");a==t&&e.addClass("on"),h.push(e)}):c.find(".frameIndicator").addClass("on"),n(f,!1),n(h,!0)}else{var r=$(d[a]),m=r.find(".segmentIndicator");m.length>0&&(r.find(".frameIndicator").removeClass("on"),m.each(function(a,i){var e=$(i).removeClass("on");a==t&&e.addClass("on")}))}this.current=i}};
;var Animation={linear:{forward:{"in":function(n,t,i){var o=$(window).height();n.css("top",-o),n.animate({top:0},t,"jswing",function(){i()})},out:function(n,t,i){var o=$(window).height();n.css("top",0),setTimeout(function(){n.animate({top:o},t-200,"jswing",function(){i()})},200)}},backward:{"in":function(n,t,i){var o=$(window).height();n.css("top",o),n.animate({top:0},t,"jswing",function(){i()})},out:function(n,t,i){var o=$(window).height();n.css("top",0),setTimeout(function(){n.animate({top:-o},t-200,"jswing",function(){i()})},200)}}},zoom:{forward:{"in":function(n,t,i){n.css({top:0,"z-index":10,opacity:0}),n.animate({opacity:1},t,"jswing",function(){i()})},out:function(n,t,i){n.animate({opacity:0},t,"jswing",function(){i()})}},backward:{"in":function(n,t,i){n.css({top:0,"z-index":10,opacity:0}),n.animate({opacity:1},t,"jswing",function(){i()})},out:function(n,t,i){n.animate({opacity:0},t,"jswing",function(){i()})}}}},Animate={state:"stop",fps:40,start:function(n,t,i){function o(){var e=(new Date).getTime();e>c?i(1):(t((e-a)/n),requestAnimationFrame(o))}var a=(new Date).getTime(),c=a+parseInt(n);o()}};
;function AnimateObject(t,n,i,a,o,r){this.dom=t,this.animType=n,this.time=i,this.delay=a,this.from=o,this.to=r,this.dom.css("top",this.from*$(window).height())}function randomX(t){var n=1/t,i=Math.random()*n,a=$(window).width()/n;return i*a-a/2}function formatNumber(t,n){for(var i=[],a=(Math.pow(10,n+1)+t+"").slice(1),o=0;n>o;o++)i.push("<b>"+a.charAt(o)+"</b>");return i.join("")}AnimateObject.prototype.render=function(t,n,i,a,o){var r=AO_animate[this.animType];r[n](this.dom,this.time,this.delay,this.from,this.to,i,a,function(){finishTask(),o&&o()})};var AO_animate={textVScroll:{"in":function(t,n,i,a,o,r,e,s){var h=$(window).height();ff=a*h,ft=o*h;var f=ff+Math.abs(ft-ff)*r;setTimeout(function(){t.animate({top:f},n,function(){s()})},i)},out:function(t,n,i,a,o,r,e,s){var h=$(window).height();ff=a*h,ft=o*h;var f=ff+Math.abs(ft-ff)*r;t.animate({top:f},n,function(){s()})}},sine:{"in":function(t,n,i,a,o,r,e,s){var h=$(window).width(),f=$(window).height(),u=t.width()/2,c=t.height()/2,m=t.attr("offsetX");m||(m=Math.random()*h/4,t.attr("offsetX",m));var d=t.attr("sineIn");d||(d=Math.round(1*Math.random())+1,t.attr("sineIn",d)),setTimeout(function(){Animate.start(2e3,function(n){var i=n,a=sineInFunc["sine"+d](i,m,h,f);t.css({left:a[0]-u,top:a[1]-c,transform:"scale("+i+", "+i+")",opacity:i})},function(){s()})},i)},out:function(t,n,i,a,o,r,e,s){var h=$(window).width(),f=$(window).height(),u=t.width()/2,c=t.height()/2,m=t.attr("offsetX");m||(m=Math.random()*h/4,t.attr("offsetX",m));var d=t.attr("sineOut");d||(d=Math.round(3*Math.random())+1,t.attr("outSin",d)),setTimeout(function(){Animate.start(1e3,function(n){var i=n,a=sineOutFunc["sine"+d](i,m,h,f);t.css({left:a[0]-u,top:a[1]-c,transform:"scale("+(i+1)+", "+(i+1)+")",opacity:1-i})},function(){s()})},i)}},count:{"in":function(t,n,i,a,o,r,e,s){function h(){if(u>=3){if(c=Math.pow(10,u-m-2),f>=o)return s(),void 0;if(f.toString().length==u){for(var n=0,i=0;u>i&&f.toString().charAt(i)==o.toString().charAt(i);i++)n++;n-m-1>0&&(m++,c=Math.pow(10,u-m-2))}f+=c,t.html(f),requestAnimationFrame(h)}else o>=f?(f++,t.html(f-1),requestAnimationFrame(h)):s()}if(1==r){var f=0,u=o.toString().length,c=1,m=0;setTimeout(h,i)}},out:function(t,n,i,a,o,r,e,s){var h=this;h["in"](t,n,i,a,o,r,e,s)}}},sineInFunc={sine1:function(t,n,i,a){var o=i/2-n,r=parseInt(n)+o*t,e=t*Math.PI,s=a/4*(1-Math.cos(e));return[r,s]},sine2:function(t,n,i,a){var o=i/2-n,r=i-o*t,e=-t*Math.PI,s=a/4*(1-Math.cos(e));return[r,s]}},sineOutFunc={sine1:function(t,n,i,a){var o=i/2-n,r=parseInt(n)+o*(1-t),e=-t*Math.PI,s=a/4+a/4*Math.cos(e);return[r,s]},sine2:function(t,n,i,a){var o=i/2-n,r=i/2+o*t,e=t*Math.PI,s=a/4+a/4*Math.cos(e);return[r,s]},sine3:function(t,n,i,a){var o=i/2-n,r=i/2+o*t,e=t*Math.PI,s=a/2+a/4*(1-Math.cos(e));return[r,s]},sine4:function(t,n,i,a){var o=i/2-n,r=parseInt(n)+o*(1-t),e=-t*Math.PI,s=a/2+a/4*(1-Math.cos(e));return[r,s]}};
;function Frame(t,i,s,a,o,e,r){this.dom=t,this.frameType=i,this.animType=s||"linear",this.time=a,this.delay=o||0,this.anims=e,this.step=r}Frame.prototype.render=function(t,i){var s=Animation[this.animType],a=this;switch(this.dom.attr("parallax")&&a._resetBackground(),t){case"backward":case"forward":"in"==i?(a.dom.css("z-index",10),a.dom.show()):a.dom.css("z-index",1),s[t][i](a.dom,a.time,function(){"out"==i&&(a.dom.hide(),a.dom.css("z-index",0)),finishTask()});break;case"static":a.dom.css("top",0),a.dom.show()}},Frame.prototype.renderAnimateObject=function(t,i,s,a){for(var o=0,e=this.anims.length;e>o;o++){var r=this.anims[o];r.render(t,i,s,this.step,a)}this.dom.attr("parallax")&&this._moveBackground(t)},Frame.prototype._moveBackground=function(t){var i=this.dom,s=i.css("background-position");if(s){var a=$.trim(s.split(" ")[1].replace("px",""));Animate.start(1e3,function(s){var o="backward"==t?1:-1,e=o*(parseInt(a)-100*s);e>0&&(e=0),i.css("background-position","0 "+e+"px")},function(){})}},Frame.prototype._resetBackground=function(){var t=this.dom;t.css("background-position","0px 0px")};
;function Scene(i,s,n,t,e){this.id=i,this.dom=s,this.frames=n,this.animType=t,this.time=e}Scene.prototype.render=function(i,s){var n=Animation[this.animType],t=this;"in"==s?(t.dom.css("z-index",10),t.dom.show()):t.dom.css("z-index",1),n[i][s](this.dom,this.time,function(){"out"==s&&(t.dom.hide(),t.dom.css("z-index",0)),finishTask()})};
;function finishTask(){if(task-1>=0){if(task--,eventQueue){var e=$.Event("keydown");e.which=1==eventQueue?40:38,$("body").trigger(e),eventQueue=0}0==task&&window.afterEvent&&window.afterEvent()}setTimeout(function(){document.body.scrollTop=0},100)}function JsMovie(e){this.scenes=[],this.si=0,this.fi=0,this.pos=0,this.animStep=0,this.scrollTimer=null,this.initialize(e)}function parseDomTree(){var e=[];return $(".scene").each(function(t,i){e.push(parseScene(i))}),e}function parseScene(e){var t=[],i=$(e),n=($(window).width(),$(window).height(),i.attr("animType")||"linear"),s=i.attr("time")||1e3,r=i.attr("id"),a=i.find(".frame");if(1==a.length){var o=parseFrame($(a[0]),"frame");t.push(o)}else a.length>1&&$.each(a,function(e,i){var n=parseFrame($(i),"segment");t.push(n)});return new Scene(r,i,t,n,s)}function parseFrame(e,t){var i=e.attr("animType")||"linear",n=e.attr("time")||500,s=e.attr("delay")||0,r=e.attr("step")||1,a=[];return e.find(".animate").each(function(e,t){var i=$(t),s=i.attr("animType")||"linear",r=i.attr("delay")||0,o=i.attr("from")||0,h=i.attr("to")||1;a.push(new AnimateObject(i,s,n,r,o,h))}),new Frame(e,t,i,n,s,a,r)}var task=0,eventQueue=null,indicator=null;JsMovie.prototype.initialize=function(e){function t(e){var t=e.deltaY,n=0>t?1:-1;(!mouseWheelHock||mouseWheelHock(n,s.si))&&i(n)}function i(e){if(!(task>0)){var t=n(e);void 0!=t[0]&&void 0!=t[1]&&beforeEvent&&beforeEvent(e,s.si,t[0],t[1])&&s.play.apply(s,t)}}function n(e){var t,i,n,r=s.scenes[s.si],a=r.frames[s.fi],o=1*e,h=a.step;if(a.anims.length>0&&s.pos-o*h<=1&&s.pos-o*h>=0)n=s.pos-o*h,t=s.si,i=s.fi;else{var c=r.frames.length>1;c?s.fi+o>=0&&s.fi+o<r.frames.length?(t=s.si,i=s.fi+o):s.si+o<s.scenes.length&&s.si+o>=0&&(t=s.si+o,i=o>0?0:s.scenes[t].frames.length-1):s.si+o>=0&&s.si+o<s.scenes.length&&(t=s.si+o,i=o>0?0:s.scenes[t].frames.length-1)}return[t,i,n]}var s=this;this.scenes=parseDomTree(),this.extraScenes=e,indicator=new Indicator(this.extraScenes,function(e,t){beforeChangePage&&beforeChangePage(e,t)&&s.play(e,t)}),s.play(0,0,-1),$("body").on("mousewheel",function(e){s.scrollTimer&&clearTimeout(s.scrollTimer),s.scrollTimer=setTimeout(function(){t(e)},100),e.preventDefault(),e.stopPropagation()}),$("body").on("keydown",function(e){38==e.which?i(-1):40==e.which&&i(1)})},JsMovie.prototype.play=function(e,t,i){e=e?parseInt(e):0,t=t?parseInt(t):0;var n=this.scenes[this.si],s=this.scenes[e],r=n.frames[this.fi],a=s.frames[t];if(e>this.si)task=2,n.render("backward","out"),a.render("static"),s.render("backward","in"),a.anims.length>0&&(task++,a.renderAnimateObject("backward","in",1),this.pos=1);else if(e<this.si)task=2,n.render("forward","out"),a.render("static"),s.render("forward","in"),a.anims.length>0&&(task++,a.renderAnimateObject("forward","in",1),this.pos=1);else if(e==this.si&&t!=this.fi)task=2,r=n.frames[this.fi],a=n.frames[t],t<this.fi?(r.render("forward","out"),a.render("forward","in"),a.anims.length>0&&(task++,a.renderAnimateObject("forward","in",1),this.pos=1)):(r.render("backward","out"),a.render("backward","in"),a.anims.length>0&&(task++,a.renderAnimateObject("backward","in",1),this.pos=1));else{if(0>i)return n.dom.show(),r.dom.show(),r.renderAnimateObject("forward","in",1),this.pos=1,void 0;r.anims.length>0&&(task=1,i<this.pos?r.renderAnimateObject("backward","out",i,function(){if(0==i){var e=$.Event("keydown");e.which=40,$("body").trigger(e)}}):r.renderAnimateObject("forward","in",i),this.pos=i)}2==this.si&&1==e?indicator.update(this.si,e,4):indicator.update(this.si,e,t),this.si=e,this.fi=t,2==e&&CodeStat.addStat({item:"panohome_subject_show"})},JsMovie.prototype.playNextScene=function(){var e=this.si+1;e>=this.scenes.length||this.play(this.si+1,0,0)},JsMovie.prototype.playPrevScene=function(){var e=this.si-1;0>e||this.play(this.si-1,0,0)},JsMovie.prototype.showScene=function(e){this.scenes[e].dom.show()};
;$("body").ready(function(){function e(){var e=navigator.userAgent.toLowerCase(),t={version:(e.match(/.+(?:rv|it|ra|ie)[\/: ]([\d.]+)/)||[0,"0"])[1],chrome:/chrome/.test(e),safari:/webkit/.test(e)&&!/chrome/.test(e),opera:/opera/.test(e),msie:/msie/.test(e)&&!/opera/.test(e),mozilla:/mozilla/.test(e)&&!/(compatible|webkit)/.test(e)};return t}function t(){function e(e){if(g-e>=0&&s>g-e&&!a){var t=$(r[g]),n=$(r[g-e]);a=!0,o=!1;var i=e*$(window).width();h.text(n.find(".desc-title").text()),d.text(n.find(".desc-text").text()),t.animate({left:i},500,"easeOutQuad",function(){t.css({"z-index":0,left:0}).hide(),n.css("z-index",8),g-=e,t.removeClass("on"),n.addClass("on"),0==g?(c.addClass("arrow-left-disable"),f.removeClass("arrow-right-disable")):g==s-1?(c.removeClass("arrow-left-disable"),f.addClass("arrow-right-disable")):(c.removeClass("arrow-left-disable"),f.removeClass("arrow-right-disable")),a=!1})}}function t(e,t){var n=g-e;if(n>=0&&s>n&&!a){o=!0;{$(r[n]).css("z-index",7).show()}currentHover=n,$(r[g]).stop().animate({left:50*e},500,"jswing",function(){t&&t()})}}function n(e){a||(o=!1,a=!0,$(r[g]).stop().animate({left:0},300,"jswing",function(){$(r[g-e]).css("z-index",0).hide(),a=!1}))}var o=!1,a=!1;currentHover=-1;var r=$(".head-banner"),s=r.length,c=$(".arrow-left"),f=$(".arrow-right"),h=$(".desc .title"),d=$(".desc .text"),u=$(r[g]);u.addClass("on").css("z-index",8),h.text(u.find(".desc-title").text()),d.text(u.find(".desc-text").text()),c.addClass("arrow-left-disable"),r.find("img").each(function(e,t){var n=i(2500,1700);t.width=n[0],t.height=n[1],$(t).css({top:-(n[1]-z)/2})}),r.find("a").click(function(){CodeStat.addStat({item:"panohome_banner_click"})}),c.on("mouseenter",function(){t(1)}),c.on("mouseleave",function(){n(1)}),c.on("click",function(){o?e(1):t(1,function(){e(1)}),CodeStat.addStat({item:"panohome_head_click"})}),f.on("mouseenter",function(){t(-1)}),f.on("mouseleave",function(){n(-1)}),f.on("click",function(){o?e(-1):t(-1,function(){e(-1)}),CodeStat.addStat({item:"panohome_head_click"})})}function n(){if(p.msie)$(".page2").remove&&$(".page2").remove();else{$(".page2").show();var e=$("#page2Iframe");if(!e.length)return;e.width($(window).width()),e.height(z)}}function i(e,t){var n=$(window).width(),i=n/e,o=t*i;return[n,o]}function o(e){var t=$(".head-banner.on img"),n=t.css("top").replace("px",""),i=t.height()-z,o=parseInt(n)-e*i/2;o>0&&(o=0),-i>o&&(o=-i),t.animate({top:o},1500)}function a(){setTimeout(function(){$(".head-banner img").each(function(e,t){var n=-($(t).height()-z)/2;$(t).stop().css({top:n})})},900)}function r(e){var t=$("#page2Iframe");return t.length?5>w+e&&w+e>0?(d(t,w+e),!1):(t.blur(),$("body").focus(),void 0):!0}function s(){var e=$("#page2Iframe");return e.length?(b?d(e,0):(w=0,e.attr("src","#"),b=!0),void 0):!0}function c(e,t){var n=$("#page2Iframe");return n.length?(y.showScene(y.si),w=t,d(n,t),indicator.update(0,1,w,"iframe"),void 0):!0}function f(){var e=$("#page2Iframe");return e.length?(b?d(e,4):(b=!0,e.focus(),w=4,e.attr("src","#")),void 0):!0}function h(e){function t(){u++,u==l&&setTimeout(function(){p.hide(),m=!1,i()},400)}function n(){m||(m=!0,c.css("top",-S*d-60),p.show())}function i(){c.stop().animate({top:-(S+e*(r-a+1))*d},800,function(){I=!1,S+=o,k+=o,g.hide()})}if(I)return!1;if(0>S+e)return!0;if(k+e>C)return!0;var o=3*e,a=S+o>0?S+o:0,r=k+o>=C?C-1:k+o;if(r>=a&&a>=0&&C>r){var s=$("#pano-wall"),c=$("#wall-container"),f=s.find(".row"),h=$(f[S]),d=h.height(),u=0,l=0,m=!1,p=s.find(".loading"),g=$("#hover-group");if(I=!0,e>0)for(var w=a;r>=w;w++){var v=$(f[w]).find("img");l+=v.length,v.each(function(e,o){return o.src?(i(),!1):(n(),o.onload=t,o.onerror=t,o.src=o.getAttribute("data-src"),void 0)})}else i();return!1}return!0}function d(e,t){if(!e.length)return!0;e.focus();var n=e.get(0).contentWindow.changePage;n&&!v&&(v=!0,w=t,n(t))}function u(){var e=!1,t=$("#pano-wall"),n=$("#wall-container"),i=$("#hover-group"),o=$("#hoverText"),a=t.find(".row"),r=(z-40)/3;o.css("line-height",r+"px"),C=a.length,n.height(C*r),n.delegate("span","mouseenter",function(t){if(!I){var n=$(t.currentTarget);if(i.show(),o.text(n.attr("title")),o.attr("subjectId",n.attr("subjectid")),e){var a=i.position(),r=n.position(),s=r.top,c=n.width(),f=n.height();a.top==s?(i.stop(),i.css({height:f}),i.animate({left:r.left,width:c},200)):a.top>s?(i.stop(),i.animate({height:0},100,function(){i.css({left:r.left,top:s+f,width:c}),i.animate({top:s,height:f},100)})):(i.stop(),i.animate({top:a.top+f,height:0},100,function(){i.css({left:r.left,top:s,width:c}),i.animate({height:f},100)}))}else{var h=n.position();i.css({left:h.left,top:h.top,width:n.width(),height:n.height()}).show(),e=!0}}}),n.on("mouseleave",function(){i.hide(),e=!1}),o.on("click",function(){var e=$(this).attr("subjectId");window.open("/panohome/subject?id="+e)})}function l(){var e=z-40;$("#pano-wall").height(e)}function m(){var e,t=0,n=0,o=!1;window.onIframeScroll=function(e,i,a){var r="key"==i?1:10;if(5==t&&0>e){if(r>n)return n++,void 0;n=0,y&&y.playNextScene(),o=!0}else if(1==t&&e>0){if(r>n)return n++,void 0;n=0,y&&y.playPrevScene(),o=!0}else{n=0,o=!1;var s=e||a;w+=s}},window.receiveMessage=function(e){if(v=!1,e){var n=e.split("-");if(n[2]){if(t=n[2],w=n[2]-1,o)return;indicator.update(0,1,w,"iframe")}}},window.onresize=function(){function t(){var e=$(window).height(),t=$(".head-banner");t.find("img").each(function(t,n){var o=i(2500,1700);n.width=o[0],n.height=o[1],$(n).css({top:-(o[1]-e)/2})});var n=$("#page2Iframe");n.length||(n.width($(window).width()),n.height(e));var o=$("#pano-wall"),a=$("#wall-container"),r=($("#hover-group"),$("#hoverText")),s=o.find(".row"),c=(e-40)/3;o.height(e-40),r.css("line-height",c+"px"),C=s.length,a.height(C*c);var f=$("#indicator");f.css("top",(e-f.height())/2)}e&&clearTimeout(e),e=setTimeout(t,100)}}CodeStat.addStat({item:"panohome"});var p=e(),g=0,w=0,v=!1,b=!1,x=!1,C=0,S=0,k=2,I=!1,z=$(window).height();$("body").height(z);var T=[{frames:[{name:"首页"}]},{frames:[{name:"全景记录"},{name:"全景的成长记录"},{name:"全景诞生"},{name:"覆盖城市"},{name:"用户上传"},{name:"采集设备"}]},{frames:[{name:"专题"}]}];p.msie&&(T=[{frames:[{name:"首页"}]},{frames:[{name:"专题"}]}]),t(),n(),l(),u(),m();var y=new JsMovie(T);window.beforeEvent=function(e,t,n,i){return t==n&&0==t&&o(e,t,n,i),0==t&&1==n&&(x=!0,a()),1!=t||2!=n&&0!=n||r(e,t,n,i),2==t&&1==n&&f(),!0},window.afterEvent=function(){var e=$("#page2Iframe");e.length&&(b?x&&(x=!1,d(e,0),$(".head-banner img").each(function(e,t){var n=-($(t).height()-z)/2;$(t).stop().css({top:n})})):1==y.si&&0==y.fi&&x&&(b=!0,x=!1,e.focus(),setTimeout(function(){},50)))},window.beforeChangePage=function(e,t){if(1==e)if(y.si<e)s(e,t),a();else{if(y.si==e)return c(e,t),!1;f(-1,e,t,null)}return!0},window.mouseWheelHock=function(e,t){return"theme"==y.scenes[t].id?h(e,t):!0}});